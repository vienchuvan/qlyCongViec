<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KPI Checklist Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>

<body>
  <div class="loading">ƒêang t·∫£i...</div>

  <section>
    <h1>üìä KPI CHECKLIST DASHBOARD</h1>
    <p>Theo d√µi hi·ªáu su·∫•t v√† ti·∫øn ƒë·ªô c√¥ng vi·ªác</p>
    <div style="
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
          gap: 15px;
        ">
      <div class="card">
        <h3>T·ªïng s·ªë c√¥ng vi·ªác</h3>
        <p id="totalTasks">0</p>
        <span>·ªîn ƒë·ªãnh</span>
      </div>
      <div class="card">
        <h3>Ho√†n th√†nh</h3>
        <p id="completedTasks">0 (0%)</p>
      </div>
      <div class="card">
        <h3>ƒêang th·ª±c hi·ªán</h3>
        <p id="inProgressTasks">0 (0%)</p>
      </div>
      <div class="card">
        <h3>Qu√° h·∫°n</h3>
        <p id="overdueTasks">0 (0%)</p>
      </div>
      <div class="card">
        <h3>ƒêi·ªÉm KPI trung b√¨nh</h3>
        <p id="averageKPI">0</p>
      </div>
    </div>
  </section>

  <section>
    <h2>üéØ Qu·∫£n l√Ω c√¥ng vi·ªác & KPI</h2>
    <div class="filter-section">
      <label>L·ªçc theo:</label>
      <select id="filterStatus" onchange="filterTasks()">
        <option value="all">T·∫•t c·∫£</option>
        <option value="ƒêang th·ª±c hi·ªán">ƒêang th·ª±c hi·ªán</option>
        <option value="Ho√†n th√†nh">Ho√†n th√†nh</option>
        <option value="Qu√° h·∫°n">Qu√° h·∫°n</option>
      </select>
      <label>∆Øu ti√™n:</label>
      <select id="filterPriority" onchange="filterTasks()">
        <option value="all">T·∫•t c·∫£</option>
        <option value="Cao">Cao</option>
        <option value="Trung b√¨nh">Trung b√¨nh</option>
        <option value="Th·∫•p">Th·∫•p</option>
      </select>
      <button onclick="downloadReport()">üì• T·∫£i b√°o c√°o</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>STT</th>
          <th>‚úì</th>
          <th>C√¥ng vi·ªác</th>
          <th>∆Øu ti√™n</th>
          <th>H·∫°n ch√≥t</th>
          <th>KPI</th>
          <th>Tr·ªçng s·ªë (%)</th>
          <th>Tr·∫°ng th√°i</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody id="taskTableBody"></tbody>
    </table>
    <!-- N√∫t Th√™m c√¥ng vi·ªác m·ªõi -->
    <button class="add-task-btn" onclick="showAddTaskModal()">
      ‚ûï Th√™m c√¥ng vi·ªác m·ªõi
    </button>
  </section>

  <!-- Modal Th√™m c√¥ng vi·ªác m·ªõi -->
  <div id="addTaskModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2>Th√™m c√¥ng vi·ªác m·ªõi</h2>
      <form id="addTaskForm">
        <label>T√™n c√¥ng vi·ªác:</label>
        <input type="text" name="name" required placeholder="Nh·∫≠p t√™n c√¥ng vi·ªác..." />
        <label>∆Øu ti√™n:</label>
        <select name="priority">
          <option value="Cao">Cao</option>
          <option value="Trung b√¨nh">Trung b√¨nh</option>
          <option value="Th·∫•p">Th·∫•p</option>
        </select>
        <label>H·∫°n ch√≥t:</label>
        <input type="datetime-local" name="deadline" required />
        <label>KPI:</label>
        <input type="number" name="kpi" min="0" max="10" step="0.1" required placeholder="0-10" />
        <label>Tr·ªçng s·ªë (%):</label>
        <input type="number" name="weight" min="1" max="100" required placeholder="1-100" />
        <label>Ghi ch√∫:</label>
        <textarea name="notes" rows="3" placeholder="Ghi ch√∫ th√™m..."></textarea>
        <div class="modal-buttons">
          <button type="button" class="close-btn" onclick="closeModal('addTaskModal')">
            H·ªßy
          </button>
          <button type="submit">Th√™m</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Employee KPI Tracking -->
  <section>
    <h2>üìä B·∫¢NG THEO D√ïI CH·∫§M KPI</h2>
    <div>
      <label>K·ª≥ ƒë√°nh gi√°:</label>
      <select id="evaluation-period">
        <option value="Q2/2025">Q2/2025</option>
        <option value="Q1/2025">Q1/2025</option>
        <option value="Q4/2024">Q4/2024</option>
      </select>
      <label>Ph√≤ng ban:</label>
      <select id="department-filter">
        <option value="T·∫•t c·∫£">T·∫•t c·∫£</option>
        <option value="IT">IT</option>
        <option value="Sales">Sales</option>
        <option value="Marketing">Marketing</option>
        <option value="HR">HR</option>
      </select>
      <button onclick="importExcel()">üì• Import t·ª´ Excel</button>
      <button onclick="exportExcel()">üì§ Xu·∫•t Excel</button>
      <!-- <button onclick="connectChecklist()">üîó K·∫øt n·ªëi Checklist</button> -->
      <button onclick="showAddEmployeeModal()">‚ûï Th√™m nh√¢n vi√™n</button>
    </div>
    <table id="kpi-table">
      <thead>
        <tr>
          <th>STT</th>
          <th>T√™n</th>
          <th>Ph√≤ng ban</th>
          <th>V·ªã tr√≠</th>
          <th>Ch·∫•t l∆∞·ª£ng</th>
          <th>Hi·ªáu su·∫•t</th>
          <th>ƒê√∫ng h·∫°n</th>
          <th>S√°ng t·∫°o</th>
          <th>L√†m vi·ªác nh√≥m</th>
          <th>Th√°i ƒë·ªô</th>
          <th>K·ªπ nƒÉng</th>
          <th>Kh√°c</th>
          <th>T·ªïng KPI</th>
          <th>X·∫øp lo·∫°i</th>
          <th>Ghi ch√∫</th>
        </tr>
      </thead>
      <tbody id="employeeTableBody"></tbody>
    </table>
  </section>

  <!-- Modal Th√™m nh√¢n vi√™n m·ªõi -->
  <div id="addEmployeeModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2>Th√™m nh√¢n vi√™n m·ªõi</h2>
      <form id="addEmployeeForm">
        <label>T√™n nh√¢n vi√™n:</label>
        <input type="text" name="name" required placeholder="Nh·∫≠p t√™n nh√¢n vi√™n..." />
        <label>Ph√≤ng ban:</label>
        <select name="department">
          <option value="IT">IT</option>
          <option value="Sales">Sales</option>
          <option value="Marketing">Marketing</option>
          <option value="HR">HR</option>
        </select>
        <label>V·ªã tr√≠:</label>
        <input type="text" name="position" required placeholder="Nh·∫≠p v·ªã tr√≠..." />
        <div class="modal-buttons">
          <button type="button" class="close-btn" onclick="closeModal('addEmployeeModal')">
            H·ªßy
          </button>
          <button type="submit">Th√™m</button>
        </div>
      </form>
    </div>
  </div>

  <!-- KPI Chart -->
  <section style="height: 580px;">
    <h2>üìà Bi·ªÉu ƒë·ªì ph√¢n b·ªë KPI</h2>
    <div style="height: 300px">
      <canvas id="kpiChart" style="    height: 80px !important;
    width: auto !important;"></canvas>
    </div>
  </section>

  <script>
    // Global variables
    let tasks = [];
    let employees = [];

    // Initialize the application
    document.addEventListener("DOMContentLoaded", function () {
      loadTasksFromAPI();
      loadNVFromAPI();
      updateDashboard();
      renderTasks();
      renderEmployees();
    });

    // Load sample data
    function loadSampleData() {
      tasks = [
        {
          id: 1,
          name: "Ph√°t tri·ªÉn t√≠nh nƒÉng m·ªõi",
          priority: "Cao",
          deadline: "2025-06-15T18:00",
          kpi: 8.5,
          weight: 30,
          status: "ƒêang th·ª±c hi·ªán",
          completed: false,
          notes: "∆Øu ti√™n cao",
        },
        {
          id: 2,
          name: "B√°o c√°o th√°ng",
          priority: "Trung b√¨nh",
          deadline: "2025-06-10T17:00",
          kpi: 7.2,
          weight: 20,
          status: "Ho√†n th√†nh",
          completed: true,
          notes: "ƒê√£ ho√†n th√†nh ƒë√∫ng h·∫°n",
        },
      ];

      employees = [
        {
          id: 1,
          name: "Nguy·ªÖn VƒÉn A",
          department: "IT",
          position: "Developer",
          quality: 8.5,
          efficiency: 7.8,
          timeliness: 9.2,
          creativity: 7.5,
          teamwork: 8.0,
          attitude: 8.8,
          skills: 8.2,
          other: 7.9,
          notes: "Hi·ªáu su·∫•t t·ªët",
        },
      ];
    }

    async function loadTasksFromAPI() {
      try {
        const response = await fetch(
          "http://localhost:3000/api/quantri/services/getTasks"
        );
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        const encrypted = decrypt(result);
        console.log("Decrypted tasks:", encrypted);

        // Gi·∫£ s·ª≠ API tr·∫£ v·ªÅ: { success: true, data: [...] }
        tasks = encrypted.data || []; // Ch·ªâ g√°n n·∫øu data l√† array

        updateDashboard();
        renderTasks();
      } catch (error) {
        console.error("Error fetching tasks:", error);
        alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c√¥ng vi·ªác t·ª´ API!");
      }
    }


    async function loadNVFromAPI() {
      try {
        const response = await fetch(
          "http://localhost:3000/api/quantri/services/getEmployees"
        );
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const result = await response.json();
        const encrypted = decrypt(result);
        console.log("Decrypted tasks:", encrypted);

        // Gi·∫£ s·ª≠ API tr·∫£ v·ªÅ: { success: true, data: [...] }
        employees = encrypted.data || []; // Ch·ªâ g√°n n·∫øu data l√† array
        renderEmployees();
      } catch (error) {
        console.error("Error fetching tasks:", error);
        alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu c√¥ng vi·ªác t·ª´ API!");
      }
    }
    // Update dashboard statistics
    function updateDashboard() {
      const totalTasks = tasks.length;
      const completedTasks = tasks.filter((t) => t.completed).length;
      const inProgressTasks = tasks.filter(
        (t) => t.status === "ƒêang th·ª±c hi·ªán"
      ).length;
      const overdueTasks = tasks.filter((t) => t.status === "Qu√° h·∫°n").length;
      const averageKPI =
        tasks.length > 0
          ? (tasks.reduce((sum, t) => sum + parseFloat(t.kpi), 0) / tasks.length).toFixed(
            1
          )
          : 0;

      document.getElementById("totalTasks").textContent = totalTasks;
      document.getElementById(
        "completedTasks"
      ).textContent = `${completedTasks} (${Math.round((completedTasks / totalTasks) * 100) || 0
      }%)`;
      document.getElementById(
        "inProgressTasks"
      ).textContent = `${inProgressTasks} (${Math.round((inProgressTasks / totalTasks) * 100) || 0
      }%)`;
      document.getElementById(
        "overdueTasks"
      ).textContent = `${overdueTasks} (${Math.round((overdueTasks / totalTasks) * 100) || 0
      }%)`;
      document.getElementById("averageKPI").textContent = averageKPI;
    }

    // Render tasks table
    function renderTasks() {
      const tbody = document.getElementById("taskTableBody");
      tbody.innerHTML = "";

      // L·ªçc theo tr·∫°ng th√°i v√† ∆∞u ti√™n
      const filterStatus = document.getElementById("filterStatus").value;
      const filterPriority = document.getElementById("filterPriority").value;

      tasks.forEach((task, index) => {
        if (
          (filterStatus === "all" || task.status === filterStatus) &&
          (filterPriority === "all" || task.priority === filterPriority)
        ) {
          const row = document.createElement("tr");
          const priorityClass =
            task.priority === "Cao"
              ? "high"
              : task.priority === "Trung b√¨nh"
                ? "medium"
                : "low";
          const statusClass =
            task.status === "Ho√†n th√†nh"
              ? "completed"
              : task.status === "ƒêang th·ª±c hi·ªán"
                ? "in-progress"
                : "overdue";

          row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><input type="checkbox" ${task.completed ? "checked" : ""
            } onchange="toggleTask(${task.id})"></td>
                        <td>${task.name}</td>
                        <td><span class="priority-badge priority-${priorityClass}">${task.priority
            }</span></td>
                        <td>${new Date(task.deadline).toLocaleString(
              "vi-VN"
            )}</td>
                        <td>${task.kpi}</td>
                        <td>${task.weight}%</td>
                        <td><span class="status-badge status-${statusClass}">${task.status
            }</span></td>
                        <td>
                            <button onclick="deleteTask(${task.id
            })" style="background: #e74c3c; font-size: 12px; padding: 5px 10px;">üóëÔ∏è X√≥a</button>
                        </td>
                    `;
          tbody.appendChild(row);
        }
      });
    }



    let kpiChartInstance = null;

    // H√†m v·∫Ω bi·ªÉu ƒë·ªì ph√¢n b·ªë KPI
    function renderKPIChart() {
      const ctx = document.getElementById('kpiChart').getContext('2d');
      // T√≠nh to√°n t·ªïng KPI cho t·ª´ng nh√¢n vi√™n
      const labels = employees.map(emp => emp.name);
      const data = employees.map(emp => {
        return (
          (parseFloat(emp.quality) +
            parseFloat(emp.efficiency) +
            parseFloat(emp.timeliness) +
            parseFloat(emp.creativity) +
            parseFloat(emp.teamwork) +
            parseFloat(emp.attitude) +
            parseFloat(emp.skills) +
            parseFloat(emp.other)) / 8
        ).toFixed(1);
      });

      // N·∫øu ƒë√£ c√≥ chart th√¨ h·ªßy tr∆∞·ªõc khi v·∫Ω l·∫°i
      if (kpiChartInstance) {
        kpiChartInstance.destroy();
      }

      kpiChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: 'T·ªïng KPI',
            data: data,
            backgroundColor: 'rgba(46, 204, 113, 0.7)',
            borderColor: 'rgba(39, 174, 96, 1)',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function (context) {
                  return `T·ªïng KPI: ${context.parsed.y}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'KPI Trung b√¨nh'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Nh√¢n vi√™n'
              }
            }
          }
        }
      });
    }


    // Render employees table
    function renderEmployees() {
      const tbody = document.getElementById("employeeTableBody");
      tbody.innerHTML = "";

      const filterDepartment =
        document.getElementById("department-filter").value;

      employees.forEach((employee, index) => {
        if (
          filterDepartment === "T·∫•t c·∫£" ||
          employee.department === filterDepartment
        ) {
          const totalKPI = (
            (parseFloat(employee.quality) +
              parseFloat(employee.efficiency) +
              parseFloat(employee.timeliness) +
              parseFloat(employee.creativity) +
              parseFloat(employee.teamwork) +
              parseFloat(employee.attitude) +
              parseFloat(employee.skills) +
              parseFloat(employee.other)) / 8
          ).toFixed(1);

          let rating = "needs-improvement";
          let ratingText = "C·∫ßn c·∫£i thi·ªán";
          if (totalKPI >= 9) {
            rating = "excellent";
            ratingText = "Xu·∫•t s·∫Øc";
          } else if (totalKPI >= 8) {
            rating = "good";
            ratingText = "T·ªët";
          } else if (totalKPI >= 7) {
            rating = "average";
            ratingText = "Trung b√¨nh";
          }

          const row = document.createElement("tr");
          row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${employee.name}</td>
                        <td>${employee.department}</td>
                        <td>${employee.position}</td>
                        <td>${employee.quality}</td>
                        <td>${employee.efficiency}</td>
                        <td>${employee.timeliness}</td>
                        <td>${employee.creativity}</td>
                        <td>${employee.teamwork}</td>
                        <td>${employee.attitude}</td>
                        <td>${employee.skills}</td>
                        <td>${employee.other}</td>
                        <td><strong>${totalKPI}</strong></td>
                        <td><span class="rating-badge rating-${rating}">${ratingText}</span></td>
                        <td>${employee.notes}</td>
                    `;
          tbody.appendChild(row);
        }
      });
      renderKPIChart();
    }

    function showAddTaskModal() {
      document.getElementById("addTaskModal").style.display = "block";
    }
    function showAddEmployeeModal() {
      document.getElementById("addEmployeeModal").style.display = "block";
    }
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = "none";
    }

    function toggleTask(taskId) {
      const task = tasks.find((t) => t.id === taskId);
      if (task) {
        task.completed = !task.completed;
        task.status = task.completed ? "Ho√†n th√†nh" : "ƒêang th·ª±c hi·ªán";

        fetch(`http://localhost:3000/api/quantri/services/updateTask/${taskId}`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            completed: task.completed,
            status: task.status,

            id: task.id,
            name: task.name,
            priority: task.priority,
            deadline: task.deadline,
            kpi: task.kpi,
            weight: task.weight,
            notes: task.notes,
          }),
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i task");
            }
            return res.json();
          })
          .then((data) => {
            // Sau khi c·∫≠p nh·∫≠t th√†nh c√¥ng, l√†m m·ªõi d·ªØ li·ªáu
            loadTasksFromAPI();
            updateDashboard();
          })
          .catch((err) => {
            console.error("L·ªói c·∫≠p nh·∫≠t task:", err);
            alert("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i task. Vui l√≤ng th·ª≠ l·∫°i.");
            // N·∫øu l·ªói, ƒë·∫£o l·∫°i tr·∫°ng th√°i c≈©
            task.completed = !task.completed;
            task.status = task.completed ? "Ho√†n th√†nh" : "ƒêang th·ª±c hi·ªán";
            renderTasks();
          });
      }
    }
    function deleteTask(taskId) {
      if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y?")) {
        fetch(`http://localhost:3000/api/quantri/services/deleteTask/${taskId}`, {
          method: "DELETE",
        })
          .then((res) => {
            if (!res.ok) {
              throw new Error("L·ªói khi x√≥a task");
            }
            return res.json();
          })
          .then((data) => {
            console.log("ƒê√£ x√≥a:", data);
            loadTasksFromAPI(); // G·ªçi l·∫°i API ƒë·ªÉ c·∫≠p nh·∫≠t danh s√°ch
          })
          .catch((err) => {
            console.error("L·ªói x√≥a task:", err);
            alert("Kh√¥ng th·ªÉ x√≥a task. Vui l√≤ng th·ª≠ l·∫°i.");
          });
      }
    }

    // Filter functions
    function filterTasks() {
      renderTasks();
    }
    document
      .getElementById("department-filter")
      .addEventListener("change", renderEmployees);

    // Placeholder functions
    function downloadReport() {
      const data = [
        [
          "STT",
          "C√¥ng vi·ªác",
          "∆Øu ti√™n",
          "H·∫°n ch√≥t",
          "KPI",
          "Tr·ªçng s·ªë (%)",
          "Tr·∫°ng th√°i",
          "Ghi ch√∫",
        ],
        ...tasks.map((task, idx) => [
          idx + 1,
          task.name,
          task.priority,
          new Date(task.deadline).toLocaleString("vi-VN"),
          task.kpi,
          task.weight,
          task.status,
          task.notes || "",
        ]),
      ];

      // T·∫°o worksheet v√† workbook
      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "CongViec");

      // Xu·∫•t file
      XLSX.writeFile(wb, "BaoCao_CongViec.xlsx");
    }
    function importExcel() {
      const input = document.createElement("input");
      input.type = "file";
      input.accept = ".xlsx,.xls";
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (evt) => {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheetName = workbook.SheetNames[0];
          const sheet = workbook.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          employees = rows.slice(1).filter(r => r.length >= 4).map((row, idx) => ({
            id: Date.now() + idx,
            name: row[1] || "",
            department: row[2] || "",
            position: row[3] || "",
            quality: parseFloat(row[4]) || 0,
            efficiency: parseFloat(row[5]) || 0,
            timeliness: parseFloat(row[6]) || 0,
            creativity: parseFloat(row[7]) || 0,
            teamwork: parseFloat(row[8]) || 0,
            attitude: parseFloat(row[9]) || 0,
            skills: parseFloat(row[10]) || 0,
            other: parseFloat(row[11]) || 0,
            notes: row[14] || ""
          }));
          renderEmployees();
          alert("Import th√†nh c√¥ng!");
        };
        reader.readAsArrayBuffer(file);
      };
      input.click();
    }
    function exportExcel() {
      const data = [
        [
          "STT",
          "T√™n",
          "Ph√≤ng ban",
          "V·ªã tr√≠",
          "Ch·∫•t l∆∞·ª£ng",
          "Hi·ªáu su·∫•t",
          "ƒê√∫ng h·∫°n",
          "S√°ng t·∫°o",
          "L√†m vi·ªác nh√≥m",
          "Th√°i ƒë·ªô",
          "K·ªπ nƒÉng",
          "Kh√°c",
          "T·ªïng KPI",
          "X·∫øp lo·∫°i",
          "Ghi ch√∫"
        ],
        ...employees.map((emp, idx) => {
          const totalKPI = (
            (parseFloat(emp.quality) +
              parseFloat(emp.efficiency) +
              parseFloat(emp.timeliness) +
              parseFloat(emp.creativity) +
              parseFloat(emp.teamwork) +
              parseFloat(emp.attitude) +
              parseFloat(emp.skills) +
              parseFloat(emp.other)) / 8
          ).toFixed(1);

          let ratingText = "C·∫ßn c·∫£i thi·ªán";
          if (totalKPI >= 9) ratingText = "Xu·∫•t s·∫Øc";
          else if (totalKPI >= 8) ratingText = "T·ªët";
          else if (totalKPI >= 7) ratingText = "Trung b√¨nh";

          return [
            idx + 1,
            emp.name,
            emp.department,
            emp.position,
            emp.quality,
            emp.efficiency,
            emp.timeliness,
            emp.creativity,
            emp.teamwork,
            emp.attitude,
            emp.skills,
            emp.other,
            totalKPI,
            ratingText,
            emp.notes || ""
          ];
        })
      ];

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "KPI_NhanVien");

      XLSX.writeFile(wb, "BaoCao_KPI_NhanVien.xlsx");
    }
    function connectChecklist() {
      alert("Ch·ª©c nƒÉng ƒëang ph√°t tri·ªÉn!");
    }

    document
      .getElementById("addTaskForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(e.target);
        const newTask = {
          name: formData.get("name"),
          priority: formData.get("priority"),
          deadline: formData.get("deadline"),
          kpi: parseFloat(formData.get("kpi")),
          weight: parseInt(formData.get("weight")),
          status: "ƒêang th·ª±c hi·ªán",
          completed: false,
          notes: formData.get("notes") || "",
        };

        fetch("http://localhost:3000/api/quantri/services/addTask", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(newTask),
        })
          .then((response) => {
            if (!response.ok) {
              throw new Error("L·ªói khi th√™m task");
            }
            return response.json();
          })
          .then((data) => {
            console.log("Th√™m task th√†nh c√¥ng:", data);
            // Sau khi th√™m th√†nh c√¥ng, g·ªçi l·∫°i API ƒë·ªÉ l·∫•y danh s√°ch m·ªõi
            loadTasksFromAPI();
            closeModal("addTaskModal");
            e.target.reset();
          })
          .catch((error) => {
            console.error("L·ªói:", error);
            alert("Th√™m task th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.");
          });
      });

    document
      .getElementById("addEmployeeForm")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const newEmployee = {
          id: Date.now(),
          name: formData.get("name"),
          department: formData.get("department"),
          position: formData.get("position"),
          quality: 0,
          efficiency: 0,
          timeliness: 0,
          creativity: 0,
          teamwork: 0,
          attitude: 0,
          skills: 0,
          other: 0,
          notes: "",
        };
        employees.push(newEmployee);
        renderEmployees();
        closeModal("addEmployeeModal");
        e.target.reset();
      });

    window.addEventListener("click", function (e) {
      if (e.target.classList.contains("modal")) {
        e.target.style.display = "none";
      }
    });

    function decrypt(data) {
      if (typeof data !== "string") {
        throw new TypeError("Data to decrypt must be a string");
      }

      const parts = data.split(":");
      if (parts.length !== 2) {
        throw new Error("Invalid encrypted data format");
      }

      const ivHex = parts[0];
      const encryptedHex = parts[1];

      const key = CryptoJS.enc.Utf8.parse("BIryQ4iRqJo1NqwJzJbMvTShcU6Iz4/b"); // ho·∫∑c l·∫•y key ƒë√∫ng theo b·∫°n d√πng
      const iv = CryptoJS.enc.Hex.parse(ivHex);
      const encrypted = CryptoJS.enc.Hex.parse(encryptedHex);

      const decrypted = CryptoJS.AES.decrypt({ ciphertext: encrypted }, key, {
        iv: iv,
        mode: CryptoJS.mode.CBC,
        padding: CryptoJS.pad.Pkcs7,
      }).toString(CryptoJS.enc.Utf8);

      try {
        return JSON.parse(decrypted);
      } catch {
        return decrypted;
      }
    }
  </script>
</body>

</html>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #333;
    line-height: 1.6;
    min-height: 100vh;
    padding: 20px;
  }

  section {
    background: rgba(255, 255, 255, 0.95);
    margin: 20px 0;
    padding: 25px;
    border-radius: 15px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
  }

  .card {
    background: linear-gradient(135deg, #3498db, #2980b9);
    color: white;
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }

  th,
  td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  th {
    background: linear-gradient(135deg, #34495e, #2c3e50);
    color: white;
    font-weight: bold;
  }

  button {
    background: linear-gradient(135deg, #e74c3c, #c0392b);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
  }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
  }

  .modal-content {
    background: white;
    margin: 5% auto;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  }

  .modal-content form {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .modal-content input,
  .modal-content select,
  .modal-content textarea {
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }

  .modal-buttons {
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    margin-top: 20px;
  }

  .priority-badge,
  .status-badge,
  .rating-badge {
    padding: 5px 10px;
    border-radius: 12px;
    font-size: 0.9em;
  }

  .priority-high {
    background: #ff4d4d;
    color: white;
  }

  .priority-medium {
    background: #ffcc00;
    color: black;
  }

  .priority-low {
    background: #4caf50;
    color: white;
  }

  .status-completed {
    background: #4caf50;
    color: white;
  }

  .status-in-progress {
    background: #2196f3;
    color: white;
  }

  .status-overdue {
    background: #f44336;
    color: white;
  }

  .rating-excellent {
    background: #4caf50;
    color: white;
  }

  .rating-good {
    background: #2196f3;
    color: white;
  }

  .rating-average {
    background: #ffc107;
    color: black;
  }

  .rating-needs-improvement {
    background: #f44336;
    color: white;
  }

  .loading {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 20px;
    border-radius: 8px;
    z-index: 10000;
  }

  .filter-section {
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    align-items: center;
    flex-wrap: wrap;
  }

  .add-task-btn {
    background: linear-gradient(135deg, #27ae60, #2ecc71);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 15px;
    box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);
  }

  .add-task-btn:hover {
    background: linear-gradient(135deg, #229954, #27ae60);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(46, 204, 113, 0.4);
  }

  .add-task-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 10px rgba(46, 204, 113, 0.3);
  }
</style>